{% extends 'base.html' %}
{% block title %}Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©{% endblock %}

{% block content %}
<form method="POST">
    {% csrf_token %}

    <div class="max-w-5xl mx-auto bg-white p-8 rounded-3xl shadow-lg space-y-8">

        <h2 class="text-3xl font-extrabold text-center text-[#2d2a32]">â• Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>

        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block font-medium mb-1">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="text" id="customerSearch" class="w-full border border-gray-300 p-3 rounded-lg"
                        placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input type="hidden" name="customer" id="customerId">
                    <div id="customerResults" class="bg-white border rounded shadow absolute z-10 hidden"></div>
                    <button type="button" class="mt-2 bg-blue-600 text-white px-3 py-2 rounded" onclick="showNewCustomerForm()">â• Ø¹Ù…ÙŠÙ„
                        Ø¬Ø¯ÙŠØ¯</button>
                </div>
                
                <div>
                    <label class="block font-medium mb-1">Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                    <select name="sale_type"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400" required>
                        <option value="Ù‚Ø·Ø§Ø¹ÙŠ">Ù‚Ø·Ø§Ø¹ÙŠ</option>
                        <option value="Ø¬Ù…Ù„Ø©">Ø¬Ù…Ù„Ø©</option>
                    </select>
                </div>
            </div>

            <div id="newCustomerForm" class="mt-6 bg-white border p-4 rounded-lg hidden">
                <h4 class="text-blue-600 font-semibold mb-3">â• Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h4>
                {{ customer_form.as_p }}
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ’³ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø®ØµÙ…</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block font-medium mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <select name="payment_method"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400">
                        <option value="Ù†Ù‚Ø¯Ù‹Ø§">Ù†Ù‚Ø¯Ù‹Ø§</option>
                        <option value="ÙÙŠØ²Ø§">ÙÙŠØ²Ø§</option>
                        <option value="Ø¢Ø¬Ù„">Ø¢Ø¬Ù„</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-1">Ø§Ù„Ø®ØµÙ…</label>
                    <input type="number" step="0.01" name="discount"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block font-medium mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <input type="number" step="0.01" name="amount_paid"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
            </div>
        </div>



        
        <!-- Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
        <div>
            <label for="barcodeInput" class="block font-semibold text-gray-700 mb-2">ğŸ“¡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <input type="text" id="barcodeInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ø¶ØºØ· Enter"
                class="w-full border border-blue-300 p-3 rounded-xl shadow-sm focus:outline-none">
        </div>

        <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
            <div id="products-area" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end product-item">
                    <select name="product_ids"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400">
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }} ({{ product.sell_price }} Ø¬.Ù…)</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="quantities"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400"
                        placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                    <button type="button" onclick="removeProduct(this)"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
            <div class="text-center">
                <button type="button" onclick="addProduct()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-semibold">â• Ø¥Ø¶Ø§ÙØ©
                    Ù…Ù†ØªØ¬
                    Ø¢Ø®Ø±</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø¹Ø¯Ø³Ø§Øª -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ•¶ï¸ Ø§Ù„Ø¹Ø¯Ø³Ø§Øª</h3>
            <div id="lenses-area" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end lens-item">
                    <select name="lens_ids"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400">
                        {% for lens in lenses %}
                        <option value="{{ lens.id }}">{{ lens.name }} ({{ lens.sell_price }} Ø¬.Ù…)</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="lens_quantities"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400"
                        placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                    <button type="button" onclick="removeLens(this)"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
            <div class="text-center">
                <button type="button" onclick="addLens()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-semibold">â• Ø¥Ø¶Ø§ÙØ©
                    Ø¹Ø¯Ø³Ø©
                    Ø£Ø®Ø±Ù‰</button>
            </div>
        </div>

        <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ -->
        <div id="invoice-summary" class="bg-blue-50 rounded-xl p-6 my-6 text-xl text-blue-900 font-bold">
            <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-amount">0</span> Ø¬.Ù…</div>
            <div>Ø§Ù„Ø®ØµÙ…: <span id="discount-amount">0</span> Ø¬.Ù…</div>
            <div>Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span id="paid-amount">0</span> Ø¬.Ù…</div>
            <div>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remaining-amount">0</span> Ø¬.Ù…</div>
        </div>

        <!-- Ø­ÙØ¸ -->
        <div class="text-center pt-6">
            <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-xl text-lg shadow-lg">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            </button>
        </div>
    </div>
</form>

<script>
    // ---- Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø§ÙŠÙ ----
    function recalculateInvoice() {
        let total = 0;

        // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        document.querySelectorAll('.product-item').forEach(function (item) {
            const select = item.querySelector('select');
            const quantity = parseFloat(item.querySelector('input[name="quantities"]').value) || 0;
            if (select && select.selectedOptions.length > 0 && quantity > 0) {
                const priceText = select.selectedOptions[0].textContent.match(/\(([\d\.,]+) Ø¬\.Ù…\)/);
                if (priceText) {
                    const price = parseFloat(priceText[1].replace(',', '.'));
                    total += price * quantity;
                }
            }
        });

        // Ø§Ù„Ø¹Ø¯Ø³Ø§Øª
        document.querySelectorAll('.lens-item').forEach(function (item) {
            const select = item.querySelector('select');
            const quantity = parseFloat(item.querySelector('input[name="lens_quantities"]').value) || 0;
            if (select && select.selectedOptions.length > 0 && quantity > 0) {
                const priceText = select.selectedOptions[0].textContent.match(/\(([\d\.,]+) Ø¬\.Ù…\)/);
                if (priceText) {
                    const price = parseFloat(priceText[1].replace(',', '.'));
                    total += price * quantity;
                }
            }
        });

        const discount = parseFloat(document.querySelector('input[name="discount"]').value) || 0;
        const paid = parseFloat(document.querySelector('input[name="amount_paid"]').value) || 0;
        const remaining = Math.max(0, total - discount - paid);

        document.getElementById('total-amount').textContent = total.toFixed(2);
        document.getElementById('discount-amount').textContent = discount.toFixed(2);
        document.getElementById('paid-amount').textContent = paid.toFixed(2);
        document.getElementById('remaining-amount').textContent = remaining.toFixed(2);
    }

    // ---- Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø³Ø§Øª ----
    function addProduct() {
        const area = document.getElementById('products-area');
        const item = area.querySelector('.product-item').cloneNode(true);
        item.querySelector('select').value = '';
        item.querySelector('input').value = '';
        item.querySelector('button').classList.remove('hidden');
        area.appendChild(item);
        recalculateInvoice();
    }

    function removeProduct(btn) {
        const item = btn.closest('.product-item');
        if (document.querySelectorAll('.product-item').length > 1) item.remove();
        else alert('ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
        recalculateInvoice();
    }

    function addLens() {
        const area = document.getElementById('lenses-area');
        const item = area.querySelector('.lens-item').cloneNode(true);
        item.querySelector('select').value = '';
        item.querySelector('input').value = '';
        item.querySelector('button').classList.remove('hidden');
        area.appendChild(item);
        recalculateInvoice();
    }

    function removeLens(btn) {
        const item = btn.closest('.lens-item');
        if (document.querySelectorAll('.lens-item').length > 1) item.remove();
        else alert('ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù„Ù‰ Ø¹Ø¯Ø³Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
        recalculateInvoice();
    }

    // ---- Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ----
    document.getElementById('barcodeInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const barcode = this.value;
            fetch(`/get-product-by-barcode/?barcode=${barcode}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const area = document.getElementById('products-area');
                        const item = area.querySelector('.product-item').cloneNode(true);
                        item.querySelector('select').value = data.id;
                        item.querySelector('input').value = 1;
                        item.querySelector('button').classList.remove('hidden');
                        area.appendChild(item);
                        this.value = '';
                        recalculateInvoice();
                    } else {
                        alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬');
                    }
                });
        }
    });

    // ---- Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ----
    const customerSearch = document.getElementById('customerSearch');
    const customerResults = document.getElementById('customerResults');
    const customerId = document.getElementById('customerId');

    customerSearch.addEventListener('input', function () {
        const q = this.value;
        if (q.length < 2) {
            customerResults.classList.add('hidden');
            return;
        }
        fetch(`/ajax/search-customers/?q=${q}`)
            .then(r => r.json())
            .then(data => {
                if (data.length) {
                    customerResults.innerHTML = data.map(c => `<div class="px-2 py-1 cursor-pointer hover:bg-blue-100" onclick="selectCustomer(${c.id}, '${c.name}')">${c.name} <span class="text-xs text-gray-400">${c.phone || ""}</span></div>`).join('');
                    customerResults.classList.remove('hidden');
                } else {
                    customerResults.innerHTML = '<div class="px-2 py-1 text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                    customerResults.classList.remove('hidden');
                }
            });
    });

    customerSearch.addEventListener('blur', function () {
        setTimeout(() => customerResults.classList.add('hidden'), 200);
    });

    // Ø¥Ø¸Ù‡Ø§Ø± ÙÙˆØ±Ù… Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ (ÙˆÙŠØ¶Ø¹ required)
    function showNewCustomerForm() {
        customerId.value = '';
        customerSearch.value = '';
        document.getElementById('newCustomerForm').classList.remove('hidden');
        // Ø¥Ø¶Ø§ÙØ© required Ù„ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        document.querySelectorAll('#newCustomerForm input, #newCustomerForm select, #newCustomerForm textarea').forEach(f => {
            if (f.name !== 'notes') f.setAttribute('required', true);
        });
    }

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨Ø­Ø« (Ø¥Ø®ÙØ§Ø¡ ÙÙˆØ±Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¥Ø²Ø§Ù„Ø© required)
    window.selectCustomer = function (id, name) {
        customerSearch.value = name;
        customerId.value = id;
        customerResults.classList.add('hidden');
        document.getElementById('newCustomerForm').classList.add('hidden');
        // Ø¥Ø²Ø§Ù„Ø© required Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ ÙÙˆØ±Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        document.querySelectorAll('#newCustomerForm input, #newCustomerForm select, #newCustomerForm textarea').forEach(f => {
            f.removeAttribute('required');
        });
    };

    // ---- Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©) ----
    document.addEventListener('DOMContentLoaded', function () {
        recalculateInvoice();
    });

    // ---- Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙƒÙ„Ù…Ø§ ØªØºÙŠØ± Ø£ÙŠ Ù…Ø¯Ø®Ù„ Ù…Ù‡Ù… ----
    document.addEventListener('input', function (e) {
        if (
            e.target.matches('.product-item select, .product-item input[name="quantities"], .lens-item select, .lens-item input[name="lens_quantities"], input[name="discount"], input[name="amount_paid"]')
        ) {
            recalculateInvoice();
        }
    });

</script>


{% endblock %}