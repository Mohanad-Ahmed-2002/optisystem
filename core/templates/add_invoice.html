{% extends 'base.html' %}
{% block title %}إضافة فاتورة{% endblock %}

{% block content %}
<form method="POST">
    {% csrf_token %}

    <div class="max-w-5xl mx-auto bg-white p-8 rounded-3xl shadow-lg space-y-8">

        <h2 class="text-3xl font-extrabold text-center text-[#2d2a32]">➕ إضافة فاتورة جديدة</h2>

        <!-- بيانات العميل -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">👤 بيانات العميل</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block font-medium mb-1">اختر العميل</label>
                    <select name="customer" id="customerSelect"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400"
                        onchange="toggleNewCustomer(this)">
                        <option value="">-- اختر --</option>
                        {% for c in customers %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                        <option value="new">➕ عميل جديد</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-1">نوع الفاتورة</label>
                    <select name="sale_type"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400" required>
                        <option value="قطاعي">قطاعي</option>
                        <option value="جملة">جملة</option>
                    </select>
                </div>
            </div>

            <div id="newCustomerForm" class="mt-6 bg-white border p-4 rounded-lg hidden">
                <h4 class="text-blue-600 font-semibold mb-3">➕ بيانات العميل الجديد</h4>
                {{ customer_form.as_p }}
            </div>
        </div>

        <!-- معلومات الفاتورة -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">💳 الدفع والخصم</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block font-medium mb-1">طريقة الدفع</label>
                    <select name="payment_method"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400">
                        <option value="نقدًا">نقدًا</option>
                        <option value="فيزا">فيزا</option>
                        <option value="آجل">آجل</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-1">الخصم</label>
                    <input type="number" step="0.01" name="discount"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block font-medium mb-1">المدفوع</label>
                    <input type="number" step="0.01" name="amount_paid"
                        class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-400">
                </div>
            </div>
        </div>



        
        <!-- الباركود -->
        <div>
            <label for="barcodeInput" class="block font-semibold text-gray-700 mb-2">📡 الباركود</label>
            <input type="text" id="barcodeInput" placeholder="اكتب الباركود واضغط Enter"
                class="w-full border border-blue-300 p-3 rounded-xl shadow-sm focus:outline-none">
        </div>

        <!-- المنتجات -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">📦 المنتجات</h3>
            <div id="products-area" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end product-item">
                    <select name="product_ids"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400">
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }} ({{ product.sell_price }} ج.م)</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="quantities"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400"
                        placeholder="الكمية">
                    <button type="button" onclick="removeProduct(this)"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">🗑️ حذف</button>
                </div>
            </div>
            <div class="text-center">
                <button type="button" onclick="addProduct()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-semibold">➕ إضافة
                    منتج
                    آخر</button>
            </div>
        </div>

        <!-- العدسات -->
        <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">🕶️ العدسات</h3>
            <div id="lenses-area" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end lens-item">
                    <select name="lens_ids"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400">
                        {% for lens in lenses %}
                        <option value="{{ lens.id }}">{{ lens.name }} ({{ lens.sell_price }} ج.م)</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="lens_quantities"
                        class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-400"
                        placeholder="الكمية">
                    <button type="button" onclick="removeLens(this)"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">🗑️ حذف</button>
                </div>
            </div>
            <div class="text-center">
                <button type="button" onclick="addLens()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-semibold">➕ إضافة
                    عدسة
                    أخرى</button>
            </div>
        </div>

        <!-- حفظ -->
        <div class="text-center pt-6">
            <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-xl text-lg shadow-lg">
                💾 حفظ الفاتورة
            </button>
        </div>
    </div>
</form>

<script>
    function toggleNewCustomer(select) {
        const form = document.getElementById('newCustomerForm');
        if (select.value === 'new') {
            form.classList.remove('hidden');
            form.querySelectorAll('input, select, textarea').forEach(f => {
                if (f.name !== 'notes') f.setAttribute('required', true);
            });
        } else {
            form.classList.add('hidden');
            form.querySelectorAll('input, select, textarea').forEach(f => {
                f.removeAttribute('required');
            });
        }
    }

    function addProduct() {
        const area = document.getElementById('products-area');
        const item = area.querySelector('.product-item').cloneNode(true);
        item.querySelector('select').value = '';
        item.querySelector('input').value = '';
        item.querySelector('button').classList.remove('hidden');
        area.appendChild(item);
    }

    function removeProduct(btn) {
        const item = btn.closest('.product-item');
        if (document.querySelectorAll('.product-item').length > 1) item.remove();
        else alert('يجب أن تحتوي الفاتورة على منتج واحد على الأقل.');
    }

    function addLens() {
        const area = document.getElementById('lenses-area');
        const item = area.querySelector('.lens-item').cloneNode(true);
        item.querySelector('select').value = '';
        item.querySelector('input').value = '';
        item.querySelector('button').classList.remove('hidden');
        area.appendChild(item);
    }

    function removeLens(btn) {
        const item = btn.closest('.lens-item');
        if (document.querySelectorAll('.lens-item').length > 1) item.remove();
        else alert('يجب أن تحتوي الفاتورة على عدسة واحدة على الأقل.');
    }

    document.getElementById('barcodeInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const barcode = this.value;
            fetch(`/get-product-by-barcode/?barcode=${barcode}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const area = document.getElementById('products-area');
                        const item = area.querySelector('.product-item').cloneNode(true);
                        item.querySelector('select').value = data.id;
                        item.querySelector('input').value = 1;
                        item.querySelector('button').classList.remove('hidden');
                        area.appendChild(item);
                        this.value = '';
                    } else {
                        alert(data.error || 'حدث خطأ أثناء جلب المنتج');
                    }
                });
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const select = document.getElementById('customerSelect');
        toggleNewCustomer(select);
    });
</script>

{% endblock %}